{% load static %}
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>{% block title %}{% endblock %} | cocoCam</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&amp;display=swap" rel="stylesheet"/>
  <link type="text/css" href="{% static 'core/css/styles.css' %}" rel="stylesheet"/>
  {% comment %} <style>
    body, html {
        margin: 0;
        font-family: 'Roboto', sans-serif;
        background-color: #1a1a1a;
        color: #fff;
    }
    .navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 40px;
        background-color: #2c2c2c;
    }
    .topnav a {
        color:#ff00ff;
        text-decoration: none;
        margin-left: 20px;
        font-size: 19px;

        margin-top: 54xp;
        text-align: left;
        font-family: sans-serif;
        font-weight: 100;
       
    }
    .terms a {
        text-decoration: none;
        margin-left: 20px;
        font-size: 30px;
    }
    .navbar .buttons a {
        background-color: #ff00ff;
        padding: 10px 20px;
        border-radius: 20px;
        color: #fff;
        margin-left: 20px;
        text-decoration: none;
    }
    .button a {
        background-color: #ff00ff;
        padding: 20px 30px;
        border-radius: 20px;
        color: #fff;
        margin-left: 40px;
        font-size: 20px;
        text-decoration: none;
    }
    .content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 40px;
        max-width: 400px;
        z-index: 2;
    }
    .content-left {
        max-width: 50%;
    }
    .content-left p {
        font-size: 18px;
        line-height: 1.6;
        margin-bottom: 20px;
    }
    .content-left .apply-button {
        background-color:#ff00ff;
        padding: 15px 30px;
        border-radius: 30px;
        color: #fff;
        text-decoration: none;
        font-size: 18px;
    }

    .con {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 40px;
        
        
    }
    .con h1 {
        text-align: center;
        font-size: 3rem;
        color: #ff00ff;
        margin-bottom: 20px;
    }

    .input-group input {
        width: 100px;
        padding: 10px 40px;
        background-color: #0d1117;
        border: 1px solid #30363d;
        border-radius: 6px;
        color: #c9d1d9;
        font-size: 16px;
    }
    .con .input-group {
        display: flex;
        align-items: center;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 17px;
    }
    .con .input-group input {
        border: none;
        background: none;
        color: #fff;
        outline: none;
        flex: 1;
        padding: 5px;
    }
    .con .input-group input:focus {
        -webkit-box-shadow: 0px 0px 10px 20px #a321cf;
        -maz-box-shadow: 0px 0px 10px 20px #a321cf;
        box-shadow: 0px 0px 10px 20px #a321cf;
    }


    .container {
        width: 400%;
        max-width: 800px;
        background-color: 0 0 10px rgba(255, 255, 255, 0.1);
        padding: 20px;
        box-shadow: 0 0 10px rgb(255, 0, 251);
        border-radius: 8px;
        padding: 40px 60px;
        
        position: absolute;
        top: 200px;
        right: 630px;
        background-color: transparent;
        border: 1px solid #a321cf;
        padding: 10px 20px;
        border-radius: 5px;
        text-decoration: none;
    }
    .logo {
        text-align: center;
        margin-bottom: 40px;
    }
    .logo h1 {
        display: inline;
        font-size: 2em;
        font-weight: bold;
        margin-left: 10px;
        vertical-align: middle;
        color: #ff00ff;
        text-align: center;
        margin-bottom: 20px;
    }

    .mandatory {
        color: #ff00ff;;
        font-size: 0.9em;
        margin-bottom: 20px;
    }
    .mandatory i {
        margin-right: 5px;
    }

    .con h7 {
        text-align: center;
        font-size: 3rem;
        color: #ff00ff;
        margin-bottom: 20px;
    }

    .cont {
        width: 400%;
        max-width: 800px;
        background-color: 0 0 10px rgba(255, 255, 255, 0.1);
        padding: 20px;
        box-shadow: 0 0 10px rgb(255, 0, 251);
        border-radius: 8px;
        padding: 40px 60px;
        
        position: absolute;
        top: 300px;
        right: 630px;
        background-color: transparent;
        border: 1px solid #a321cf;
        padding: 10px 20px;
        border-radius: 5px;
        text-decoration: none;
    }

    .con h6 {
        
        font-size: 3rem;
        color: #ff00ff;
        margin-bottom: 20px;
    }




    .StripeElement {
      box-sizing: border-box;

      height: 40px;

      padding: 10px 12px;

      border: 1px solid transparent;
      border-radius: 4px;
      background-color: white;

      box-shadow: 0 1px 3px 0 #e6ebf1;
      -webkit-transition: box-shadow 150ms ease;
      transition: box-shadow 150ms ease;
    }

    .StripeElement--focus {
      box-shadow: 0 1px 3px 0 #cfd7df;
    }

    .StripeElement--invalid {
      border-color: #fa755a;
    }

    .StripeElement--webkit-autofill {
      background-color: #fefde5 !important;
    }
    .hidden {
        display: none;
    }


    #submit:hover {
      filter: contrast(120%);
    }

    #submit {
      font-feature-settings: "pnum";
      --body-color: #f7fafc;
      --button-color: #556cd6;
      --accent-color: #556cd6;
      --gray-border: #e3e8ee;
      --link-color: #fff;
      --font-color: #697386;
      --body-font-family: -apple-system,BlinkMacSystemFont,sans-serif;
      --radius: 4px;
      --form-width: 400px;
      -webkit-box-direction: normal;
      word-wrap: break-word;
      box-sizing: border-box;
      font: inherit;
      overflow: visible;
      -webkit-appearance: button;
      -webkit-font-smoothing: antialiased;
      margin: 0;
      font-family: inherit;
      -webkit-tap-highlight-color: transparent;
      font-size: 16px;
      padding: 0 12px;
      line-height: 32px;
      outline: none;
      text-decoration: none;
      text-transform: none;
      margin-right: 8px;
      height: 36px;
      border-radius: var(--radius);
      color: #fff;
      border: 0;
      margin-top: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s ease;
      display: block;
      box-shadow: 0 4px 5.5px 0 rgba(0,0,0,.07);
      width: 100%;
      background: var(--button-color);
    } {% endcomment %}
         
    </style>
 </head>
 <body>
  <div class="navbar">
    <p class="terms">
        <a href="/" style="text-decoration:none;color:#ff00ff;">
            COCOCAM
        </a>
    </p>
        <div class="topnav">
            <a href="#">Home</a>
            <a href="{% url "core:about" %}">About</a>
            <a href="{% url "core:pricing" %}">Pricing</a>
            <a href="{% url 'link:links' %}">Links</a>
            <a href="{% url 'dashboard:dashboard' %}">Dashboard</a>
            <a href="{% url 'link:categories' %}">Categories</a>
            <a href="{% url 'link:subscription' %}">Subscription</a>
        </div>
   <div class="buttons">
        <a href="{% url 'link:create_link' %}">
            Create link
        </a>
        <a href="{% url 'accounts:logout' %}">
            Logout
        </a>
    
   </div>
  </div>
    <main>
        {% block content %}{% endblock %}
    </main>
    <script>
        document.getElementById("submit").disabled = true;

        stripeElements();
        
        function stripeElements() {
          stripe = Stripe('pk_test_51QkVEiQ03ifYEgfTAZa9CN0SaNx6WigSag5wWD1Jh6kyWJm6BMXXYFR2pUjPB0QmHNUP8FM7n5kxnV878Ieecur6005etaGyp3');
        
          if (document.getElementById('card-element')) {
            let elements = stripe.elements();
        
            // Card Element styles
            let style = {
              base: {
                color: "#32325d",
                fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                fontSmoothing: "antialiased",
                fontSize: "16px",
                "::placeholder": {
                  color: "#aab7c4"
                }
              },
              invalid: {
                color: "#fa755a",
                iconColor: "#fa755a"
              }
            };
        
        
            card = elements.create('card', { style: style });
        
            card.mount('#card-element');
        
            card.on('focus', function () {
              let el = document.getElementById('card-errors');
              el.classList.add('focused');
            });
        
            card.on('blur', function () {
              let el = document.getElementById('card-errors');
              el.classList.remove('focused');
            });
        
            card.on('change', function (event) {
              displayError(event);
            });
          }
          //we'll add payment form handling here
        }
        
        function displayError(event) {
         
          let displayError = document.getElementById('card-errors');
          if (event.error) {
            displayError.textContent = event.error.message;
          } else {
            displayError.textContent = '';
          }
        }

        function planSelect(name, price, priceId) {
            var inputs = document.getElementsByTagName('input');
        
            for(var i = 0; i<inputs.length; i++){
              inputs[i].checked = false;
              if(inputs[i].name== name){
        
                inputs[i].checked = true;
              }
            }
        
            var n = document.getElementById('plan');
            var p = document.getElementById('price');
            var pid = document.getElementById('priceId');
            n.innerHTML = name;
            p.innerHTML = price;
            pid.innerHTML = priceId;
                document.getElementById("submit").disabled = false;
          }

          let paymentForm = document.getElementById('subscription-form');
          if (paymentForm) {
        
            paymentForm.addEventListener('submit', function (evt) {
              evt.preventDefault();
              changeLoadingState(true);
        
        
                // create new payment method & create subscription
                createPaymentMethod({ card });
            });
          }

          function createPaymentMethod({ card }) {

            // Set up payment method for recurring usage
            let billingName = '{{user.username}}';
          
            stripe
              .createPaymentMethod({
                type: 'card',
                card: card,
                billing_details: {
                  name: billingName,
                },
              })
              .then((result) => {
                if (result.error) {
                  displayError(result);
                } else {
                 const paymentParams = {
                    price_id: document.getElementById("priceId").innerHTML,
                    payment_method: result.paymentMethod.id,
                };
                fetch("/create-sub/", {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken':'{{ csrf_token }}',
                  },
                  credentials: 'same-origin',
                  body: JSON.stringify(paymentParams),
                }).then((response) => {
                  return response.json(); 
                }).then((result) => {
                  if (result.error) {
                    // The card had an error when trying to attach it to a customer
                    throw result;
                  }
                  return result;
                }).then((result) => {
                  if (result && result.status === 'active') {
          
                   window.location.href = '/complete/';
                  };
                }).catch(function (error) {
                    displayError(result.error.message);
          
                });
                }
              });
          }
          
          
          var changeLoadingState = function(isLoading) {
            if (isLoading) {
              document.getElementById("submit").disabled = true;
              document.querySelector("#spinner").classList.remove("hidden");
              document.querySelector("#button-text").classList.add("hidden");
            } else {
              document.getElementById("submit").disabled = false;
              document.querySelector("#spinner").classList.add("hidden");
              document.querySelector("#button-text").classList.remove("hidden");
            }
          };
    </script>

    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#cancel-subscription-button').on('click', function(e) {
                e.preventDefault();  // Предотвращаем переход по ссылке

                // Отправляем AJAX-запрос на сервер
                $.ajax({
                    url: '/cancel/',  // URL для отмены подписки
                    method: 'POST',
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}"  // Передаем CSRF-токен
                    },
                    success: function(response) {
                        alert('Subscription will be canceled at the end of the period.');  // Уведомляем пользователя
                        $('#cancel-subscription-button').hide();  // Скрываем кнопку отмены
                    },
                    error: function(error) {
                        alert('An error occurred: ' + error.responseJSON.error);  // Показываем ошибку
                    }
                });
            });
        });
    </script>
        
    <script>
        // Функция для проверки и обновления токена
        async function ensureAuthenticated() {
            const accessToken = localStorage.getItem('accessToken');
            if (!accessToken) {
                throw new Error('No access token');
            }
    
            try {
                // Проверяем срок действия токена
                const payload = JSON.parse(atob(accessToken.split('.')[1]));
                const isExpired = Date.now() >= payload.exp * 1000;
    
                if (isExpired) {
                    return await refreshToken();
                }
                return accessToken;
            } catch (e) {
                console.error('Token validation error:', e);
                throw e;
            }
        }
    
        // Функция обновления токена
        async function refreshToken() {
            const refreshToken = localStorage.getItem('refreshToken');
            if (!refreshToken) {
                throw new Error('No refresh token');
            }
    
            const response = await fetch('/auth/jwt/refresh/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ refresh: refreshToken })
            });
    
            if (!response.ok) {
                throw new Error('Token refresh failed');
            }
    
            const data = await response.json();
            localStorage.setItem('accessToken', data.access);
            return data.access;
        }
    
        // Защищенный запрос при загрузке страницы
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const token = await ensureAuthenticated();
                
                // Загружаем страницу с токеном в заголовках
                const response = await fetch(window.location.href, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });
    
                if (response.status === 401) {
                    window.location.href = "{% url 'accounts:login' %}";
                    return;
                }
    
                // Обработчик для формы
                const form = document.getElementById('create-link-form');
                if (form) {
                    form.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        
                        try {
                            const token = await ensureAuthenticated();
                            const formData = new FormData(form);
                            
                            const response = await fetch(form.action, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                                },
                                body: formData
                            });
    
                            if (response.redirected) {
                                window.location.href = response.url;
                            } else if (response.ok) {
                                const data = await response.json();
                                if (data.redirect) {
                                    window.location.href = data.redirect;
                                }
                            } else {
                                const error = await response.json();
                                alert(error.error || 'Error occurred');
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Authentication failed. Please login again.');
                            window.location.href = "{% url 'accounts:login' %}";
                        }
                    });
                }
            } catch (error) {
                console.error('Authentication error:', error);
                window.location.href = "{% url 'accounts:login' %}";
            }
        });
    </script>
      
    <!-- CSRF Token -->
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    </body>
</html>